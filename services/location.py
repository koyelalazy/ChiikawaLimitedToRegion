from geopy.geocoders import Nominatim

# --- 🔥 強制座標修正表 ---
# 這裡列出的地點，程式會直接使用設定好的座標，不再去問地圖 (避免問錯)
LOCATION_CORRECTIONS = {
    "市川市": {"lat": 35.7196, "lng": 139.9264, "region": "關東"},
    "大涌谷": {"lat": 35.2426, "lng": 139.0204, "region": "關東"},
    "靜岡": {"lat": 34.9756, "lng": 138.3828, "region": "中部"},
    "埼玉": {"lat": 35.8616, "lng": 139.6455, "region": "關東"},
    "澳門": {"lat": 22.1987, "lng": 113.5439, "region": "海外"},
    "秋田": {"lat": 39.7200, "lng": 140.1026, "region": "東北"},
    "鹿児島": {"lat": 31.5966, "lng": 130.5571, "region": "九州"},
    "鹿兒島": {"lat": 31.5966, "lng": 130.5571, "region": "九州"},
    "北海道": {"lat": 43.0618, "lng": 141.3545, "region": "北海道"},
    "京都": {"lat": 35.0116, "lng": 135.7681, "region": "近畿"},
    "滋賀": {"lat": 35.0045, "lng": 135.8686, "region": "近畿"},
    "澳洲": {"lat": -25.2744, "lng": 133.7751, "region": "海外"},
    "岩手": {"lat": 39.7020, "lng": 141.1545, "region": "東北"},
    "東京": {"lat": 35.6895, "lng": 139.6917, "region": "關東"},
    "足利": {"lat": 36.3328, "lng": 139.4524, "region": "關東"},
    "沖繩": {"lat": 26.2124, "lng": 127.6809, "region": "沖繩"},
    "奈良": {"lat": 34.6851, "lng": 135.8048, "region": "近畿"},
    "茨城": {"lat": 36.3659, "lng": 140.4700, "region": "關東"},
    "栃木": {"lat": 36.5551, "lng": 139.8828, "region": "關東"},
    "香港": {"lat": 22.3193, "lng": 114.1694, "region": "海外"},
    "青森": {"lat": 40.8222, "lng": 140.7474, "region": "東北"},
    "宮崎": {"lat": 31.9077, "lng": 131.4202, "region": "九州"},
    "福岡": {"lat": 33.5902, "lng": 130.4017, "region": "九州"},
    "富山": {"lat": 36.6953, "lng": 137.2137, "region": "中部"},
    "岡山": {"lat": 34.6555, "lng": 133.9198, "region": "中國"},
    "広島": {"lat": 34.3853, "lng": 132.4553, "region": "中國"},
    "廣島": {"lat": 34.3853, "lng": 132.4553, "region": "中國"},
    "函館": {"lat": 41.7687, "lng": 140.7288, "region": "北海道"},
    "尾道": {"lat": 34.4063, "lng": 133.1953, "region": "中國"},
    "千葉": {"lat": 35.6074, "lng": 140.1063, "region": "關東"},
    "山形": {"lat": 38.2554, "lng": 140.3396, "region": "東北"},
    "飛驒": {"lat": 36.1460, "lng": 137.2523, "region": "中部"},
    "飛騨": {"lat": 36.1460, "lng": 137.2523, "region": "中部"},
    "島根": {"lat": 35.4681, "lng": 133.0484, "region": "中國"},
    "神戶": {"lat": 34.6901, "lng": 135.1955, "region": "近畿"},
    "大阪": {"lat": 34.6937, "lng": 135.5023, "region": "近畿"},
    "山口": {"lat": 34.1785, "lng": 131.4738, "region": "中國"},
    "新潟": {"lat": 37.9162, "lng": 139.0364, "region": "中部"},
    "佐賀": {"lat": 33.2635, "lng": 130.3009, "region": "九州"},
    "箱根": {"lat": 35.2324, "lng": 139.1069, "region": "關東"},
    "長崎": {"lat": 32.7503, "lng": 129.8777, "region": "九州"},
    "三重": {"lat": 34.7186, "lng": 136.5084, "region": "近畿"},
    "鎌倉": {"lat": 35.3191, "lng": 139.5505, "region": "關東"},
    "宮島": {"lat": 34.2980, "lng": 132.3225, "region": "中國"},
    "群馬": {"lat": 36.3895, "lng": 139.0634, "region": "關東"},
    "金閣寺": {"lat": 35.0394, "lng": 135.7292, "region": "近畿"},
    "香川": {"lat": 34.3401, "lng": 134.0433, "region": "四國"},
    "山陰": {"lat": 35.5043, "lng": 133.2333, "region": "中國"},
    "福島": {"lat": 37.7608, "lng": 140.4747, "region": "東北"},
    "名古屋": {"lat": 35.1815, "lng": 136.9066, "region": "中部"},
    "山梨": {"lat": 35.6621, "lng": 138.5688, "region": "中部"},
    "石川": {"lat": 36.5613, "lng": 136.6562, "region": "中部"},
    "和歌山": {"lat": 34.2257, "lng": 135.1675, "region": "近畿"},
    "福井": {"lat": 36.0641, "lng": 136.2196, "region": "中部"},
    "雷門": {"lat": 35.7111, "lng": 139.7964, "region": "關東"},
    "兵庫": {"lat": 34.6901, "lng": 135.1955, "region": "近畿"},
    "宮城": {"lat": 38.2682, "lng": 140.8694, "region": "東北"},
    "瀨戶內": {"lat": 34.4, "lng": 133.2, "region": "中國"},
    "高知": {"lat": 33.5588, "lng": 133.5311, "region": "四國"},
    "愛媛": {"lat": 33.8392, "lng": 132.7656, "region": "四國"},
    "鳴門": {"lat": 34.1783, "lng": 134.6090, "region": "四國"},
    "徳島": {"lat": 34.0703, "lng": 134.5548, "region": "四國"},
    "德島": {"lat": 34.0703, "lng": 134.5548, "region": "四國"},
    "大分": {"lat": 33.2396, "lng": 131.6093, "region": "九州"},
    "熊本": {"lat": 32.8032, "lng": 130.7079, "region": "九州"},
    "信州": {"lat": 36.6485, "lng": 138.1942, "region": "中部"},
    "北九州": {"lat": 33.8835, "lng": 130.8752, "region": "九州"},
    "奄美": {"lat": 28.3828, "lng": 129.4993, "region": "九州"},
    "清水": {"lat": 35.0161, "lng": 138.4863, "region": "中部"},
    "日光": {"lat": 36.7481, "lng": 139.6168, "region": "關東"},
    "草津": {"lat": 36.6228, "lng": 138.5961, "region": "關東"},
    "淡路": {"lat": 34.3432, "lng": 134.8139, "region": "近畿"},
    "博多": {"lat": 33.5897, "lng": 130.4207, "region": "九州"},
    "別府": {"lat": 33.2776, "lng": 131.5029, "region": "九州"},
    "石垣": {"lat": 24.3448, "lng": 124.1572, "region": "沖繩"},
    "宮古": {"lat": 24.8055, "lng": 125.2811, "region": "沖繩"},
    "出雲": {"lat": 35.3696, "lng": 132.7556, "region": "中國"},
    "橫濱": {"lat": 35.4437, "lng": 139.6380, "region": "關東"},
    "横浜": {"lat": 35.4437, "lng": 139.6380, "region": "關東"},
    "富士山": {"lat": 35.3606, "lng": 138.7274, "region": "中部"},
    "合掌村": {"lat": 36.2561, "lng": 136.9044, "region": "中部"},
    "白川鄉": {"lat": 36.2561, "lng": 136.9044, "region": "中部"},
    "空港": {"lat": 35.5494, "lng": 139.7798, "region": "其他"},
    "姬路": {"lat": 34.8270, "lng": 134.6903, "region": "近畿"}, # 🔥 新增：姬路
}

# --- 地點 -> 分區 對照表 (關鍵字查詢用) ---
PREFECTURE_TO_REGION = {
    "北海道": "北海道", "札幌": "北海道", "函館": "北海道", "小樽": "北海道",
    "青森": "東北", "岩手": "東北", "宮城": "東北", "秋田": "東北", "山形": "東北", "福島": "東北", "仙台": "東北",
    "茨城": "關東", "栃木": "關東", "群馬": "關東", "埼玉": "關東", "千葉": "關東", "東京": "關東", "神奈川": "關東",
    "市川": "關東", "足利": "關東", "橫濱": "關東", "横浜": "關東", "箱根": "關東", "鎌倉": "關東", "日光": "關東", "草津": "關東", "東日本": "關東",
    "新潟": "中部", "富山": "中部", "石川": "中部", "福井": "中部", "山梨": "中部", "長野": "中部", "岐阜": "中部", "靜岡": "中部", "静岡": "中部", "愛知": "中部",
    "信州": "中部", "清水": "中部", "次郎長": "中部", "飛驒": "中部", "飛騨": "中部", "名古屋": "中部", "富士山": "中部", "合掌村": "中部", "東海": "中部",
    "三重": "近畿", "滋賀": "近畿", "京都": "近畿", "大阪": "近畿", "兵庫": "近畿", "奈良": "近畿", "和歌山": "近畿",
    "淡路": "近畿", "神戶": "近畿", "伏見": "近畿", "伊勢": "近畿", "姬路": "近畿", "金閣寺": "近畿", "西日本": "近畿",
    "鳥取": "中國", "島根": "中國", "岡山": "中國", "廣島": "中國", "広島": "中國", "山口": "中國",
    "宮島": "中國", "出雲": "中國",
    "德島": "四國", "徳島": "四國", "香川": "四國", "愛媛": "四國", "高知": "四國", "鳴門": "四國",
    "福岡": "九州", "佐賀": "九州", "長崎": "九州", "熊本": "九州", "大分": "九州", "宮崎": "九州", "鹿兒島": "九州", "鹿児島": "九州",
    "奄美": "九州", "博多": "九州", "別府": "九州",
    "沖繩": "沖繩", "沖縄": "沖繩", "石垣": "沖繩", "宮古": "沖繩",
    "香港": "海外", "澳門": "海外", "澳洲": "海外", "台灣": "海外", "韓國": "海外", "ハワイ": "海外"
}

REGION_COORDS = {
    "北海道": {"lat": 43.0618, "lng": 141.3545}, "東北": {"lat": 38.2682, "lng": 140.8694},
    "關東": {"lat": 35.6895, "lng": 139.6917}, "中部": {"lat": 35.1815, "lng": 136.9066},
    "近畿": {"lat": 34.6937, "lng": 135.5023}, "中國": {"lat": 34.3853, "lng": 132.4553},
    "四國": {"lat": 34.3428, "lng": 134.0466}, "九州": {"lat": 33.5904, "lng": 130.4017},
    "沖繩": {"lat": 26.2124, "lng": 127.6809}, "海外": {"lat": 22.3193, "lng": 114.1694},
    "其他": {"lat": 35.0, "lng": 139.0}, "空港": {"lat": 35.5494, "lng": 139.7798}
}

SPOT_COORDS = {
    "伏見": {"lat": 34.9671, "lng": 135.7727}, "稲荷": {"lat": 34.9671, "lng": 135.7727},
    "京都": {"lat": 35.0116, "lng": 135.7681}, "清水寺": {"lat": 34.9949, "lng": 135.7850},
    "八橋": {"lat": 35.0035, "lng": 135.7727}, "奈良": {"lat": 34.6851, "lng": 135.8048},
    "鹿": {"lat": 34.6851, "lng": 135.8048}, "大佛": {"lat": 34.6851, "lng": 135.8048},
    "神戶": {"lat": 34.6901, "lng": 135.1955}, "通天閣": {"lat": 34.6525, "lng": 135.5063},
    "大阪城": {"lat": 34.6873, "lng": 135.5262}, "伊勢": {"lat": 34.4550, "lng": 136.7258},
    "雷門": {"lat": 35.7111, "lng": 139.7964}, "淺草": {"lat": 35.7111, "lng": 139.7964},
    "晴空塔": {"lat": 35.7100, "lng": 139.8107}, "東京鐵塔": {"lat": 35.6586, "lng": 139.7454},
    "熊貓": {"lat": 35.7141, "lng": 139.7741}, "箱根": {"lat": 35.2324, "lng": 139.1069},
    "鎌倉": {"lat": 35.3191, "lng": 139.5505}, "大仏": {"lat": 35.3167, "lng": 139.5361},
    "日光": {"lat": 36.7199, "lng": 139.6982}, "草津": {"lat": 36.6228, "lng": 138.5961},
    "富士山": {"lat": 35.3606, "lng": 138.7274}, "合掌村": {"lat": 36.2561, "lng": 136.9044},
    "白川鄉": {"lat": 36.2561, "lng": 136.9044}, "名古屋": {"lat": 35.1815, "lng": 136.9066},
    "太宰府": {"lat": 33.5215, "lng": 130.5349}, "熊本城": {"lat": 32.8062, "lng": 130.7058},
    "櫻島": {"lat": 31.5932, "lng": 130.6574}, "石垣": {"lat": 24.3448, "lng": 124.1572},
    "水族館": {"lat": 26.6943, "lng": 127.8779}, "函館": {"lat": 41.7687, "lng": 140.7288},
    "仙台": {"lat": 38.2682, "lng": 140.8694}, "廣島": {"lat": 34.3853, "lng": 132.4553},
    "宮島": {"lat": 34.2960, "lng": 132.3199}, "沙丘": {"lat": 35.5413, "lng": 134.2294},
    "出雲": {"lat": 35.4020, "lng": 132.6855}, "群馬": {"lat": 36.3895, "lng": 139.0634},
    "清水": {"lat": 35.0160, "lng": 138.4863}, "次郎長": {"lat": 35.0160, "lng": 138.4863},
    "空港": {"lat": 35.5494, "lng": 139.7798}, "パイロット": {"lat": 35.5494, "lng": 139.7798},
    "飛行機": {"lat": 35.7720, "lng": 140.3929}, "香港": {"lat": 22.3193, "lng": 114.1694},
    "澳門": {"lat": 22.1987, "lng": 113.5439}, "澳洲": {"lat": -25.2744, "lng": 133.7751},
}

REGION_KEYWORDS = {
    "北海道": ["北海道", "札幌", "富良野", "函館", "小樽", "旭山", "薰衣草", "ラベンダー", "哈密瓜", "メロン", "玉米", "とうもろこし", "熊", "クマ", "鮭魚", "鮭", "狐狸", "キツネ", "丹頂鶴", "流冰", "クリオネ", "成吉思汗", "ジンギスカン", "拉麵", "ラーメン", "雪", "長尾山雀", "銀喉長尾山雀", "シマエナガ"],
    "東北": ["東北", "青森", "岩手", "宮城", "秋田", "山形", "福島", "仙台", "蘋果", "りんご", "睡魔", "ねぶた", "赤貝", "赤べこ", "伊達", "政宗", "毛豆", "ずんだ", "牛舌", "牛タン", "生剝鬼", "なまはげ", "小芥子", "こけし", "白虎隊", "米沢牛", "三陸", "碗子蕎麥", "わんこそば", "櫻桃", "さくらんぼ"],
    "關東": ["關東", "関東", "東京", "神奈川", "千葉", "埼玉", "茨城", "栃木", "群馬", "雷門", "浅草", "淺草", "晴空塔", "スカイツリー", "東京鐵塔", "東京タワー", "熊貓", "パンダ", "上野", "澀谷", "渋谷", "八公", "ハチ公", "箱根", "大涌谷", "黑蛋", "黒たまご", "寄木細工", "橫濱", "横浜", "中華街", "燒賣", "シューマイ", "鎌倉", "大佛", "大仏", "江之島", "草津", "日光", "猴子", "猿", "餃子", "納豆", "花生", "落花生", "東日本"],
    "中部": ["中部", "愛知", "名古屋", "靜岡", "静岡", "岐阜", "長野", "山梨", "新潟", "富山", "石川", "福井", "北陸", "信州", "飛驒", "飛騨", "富士山", "ふじさん", "茶", "お茶", "わさび", "山葵", "鰻魚", "うなぎ", "金鯱", "しゃちほこ", "炸蝦", "エビフライ", "紅豆吐司", "小倉トースト", "合掌村", "白川鄉", "猴子泡湯", "蘋果", "蕎麥", "そば", "越光米", "米", "螃蟹", "カニ", "鬱金香", "チューリップ", "雷鳥", "清水", "次郎長", "東海"],
    "近畿": ["近畿", "關西", "関西", "大阪", "京都", "兵庫", "神戶", "神戸", "奈良", "滋賀", "和歌山", "三重", "伊勢", "章魚燒", "たこ焼", "通天閣", "大阪城", "好燒", "お好み焼き", "虎", "タイガース", "豹紋", "八橋", "八ッ橋", "抹茶", "新選組", "舞妓", "伏見稻荷", "伏見稲荷", "狐", "清水寺", "鹿", "大佛", "信樂燒", "狸貓", "琵琶湖", "彥根貓", "熊貓", "パンダ", "梅", "橘子", "みかん", "珍珠", "真珠", "金閣寺", "西日本"],
    "中國": ["中國", "中国", "廣島", "広島", "岡山", "鳥取", "島根", "山口", "瀨戶內", "瀬戸内", "檸檬", "レモン", "楓葉", "もみじ", "紅葉饅頭", "廣島燒", "牡蠣", "桃太郎", "牛仔褲", "麝香葡萄", "沙丘", "梨", "二十世紀梨", "白兔", "因幡", "いなばの白うさぎ", "河豚", "ふく", "ふぐ"],
    "四國": ["四國", "四国", "香川", "德島", "徳島", "愛媛", "高知", "烏龍麵", "うどん", "橄欖", "オリーブ", "橘子", "みかん", "伊予", "道後", "少爺", "坊っちゃん", "阿波", "阿波舞", "鳴門", "漩渦", "鰹魚", "カツオ", "柚子"],
    "九州": ["九州", "福岡", "博多", "佐賀", "長崎", "熊本", "大分", "宮崎", "鹿兒島", "鹿児島", "明太子", "拉麵", "ラーメン", "草莓", "あまおう", "太宰府", "長崎蛋糕", "カステラ", "眼鏡橋", "熊", "くまモン", "熊本城", "別府", "由布院", "芒果", "日南", "摩艾", "黑豬", "黒豚", "白熊", "冰", "しろくま", "櫻島", "蘿蔔"],
    "沖繩": ["沖繩", "沖縄", "那霸", "石垣", "宮古", "風獅爺", "シーサー", "扶桑花", "ハイビスカス", "鳳梨", "パイン", "紅芋", "苦瓜", "ゴーヤ", "水族館", "鯨鯊", "ジンベエザメ", "三線", "水牛", "星砂"],
    "海外": ["香港", "澳門", "台灣", "澳洲", "ハワイ"]
}

def get_region_from_address(address):
    for place, region in PREFECTURE_TO_REGION.items():
        if place in address: return region
    return None

def apply_region_logic(item):
    loc_str = item.get('search_location', '')
    name = item.get('name', '')
    new_region = None
    
    # 🔥 優先使用強制修正表
    if loc_str and loc_str in LOCATION_CORRECTIONS:
        return LOCATION_CORRECTIONS[loc_str]['region']

    if loc_str:
        new_region = get_region_from_address(loc_str)
        if not new_region:
            if "空港" in loc_str or "機場" in loc_str:
                new_region = "其他"
    
    if not new_region:
        if "パイロット" in name or "飛行機" in name or "CA" in name:
            new_region = "其他" 
        else:
            for r_key, keywords in REGION_KEYWORDS.items():
                if any(k in name for k in keywords):
                    new_region = r_key
                    break
    
    if not new_region:
        new_region = "其他"
    return new_region